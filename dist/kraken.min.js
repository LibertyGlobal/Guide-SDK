// Kraken
// ----------------------------------
// v0.0.1
//
// Copyright (c) 2013 Liberty Global
// Distributed under BSD license

!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define(b):a.kraken=a.K=b()}(this,function(){function a(){this.initialRequestURL="",this.nextBatchLink=""}function b(a){this._name=a}function c(a){b.call(this,a)}function d(a){b.call(this,a)}function e(a){this.items=[],"undefined"!=typeof a&&this.add(a)}function f(){e.call(this),this._queryStringElements=[],this._requestURL="",this._request=new a}var g={},h=g;h.utils={addFactory:function(a){a.create=function(){return new a}}};var i=function(){function a(a,b){var c=document.createElement("script"),d=!1;c.src=a,c.async=!0;var f=b||h.error;"function"==typeof f&&(c.onerror=function(b){f({url:a,event:b})}),c.onload=c.onreadystatechange=function(){d||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(d=!0,c.onload=c.onreadystatechange=null,c&&c.parentNode&&c.parentNode.removeChild(c))},e||(e=document.getElementsByTagName("head")[0]),e.appendChild(c)}function b(a){return encodeURIComponent(a)}function c(a,b){var c=a.split("?");if(c.length>=2){for(var d=c.shift(),e=c.join("?"),f=encodeURIComponent(b)+"=",g=e.split(/[&;]/g),h=g.length;h-->0;)-1!==g[h].lastIndexOf(f,0)&&g.splice(h,1);a=d+"?"+g.join("&")}return a}function d(d,e,i,j){var k,l=-1===(d||"").indexOf("?")?"?":"&";j=j||h.callbackName||"callback";var m=j+"_json"+ ++f;d=c(d,j),e=e||{};for(k in e)e.hasOwnProperty(k)&&(l+=b(k)+"="+b(e[k])+"&");return g[m]=function(a){i(a);try{delete g[m]}catch(b){}g[m]=null},a(d+l+j+"="+m),m}var e,f=0,g=this,h={};return d},j=function(){function a(a,b,c){var d=require("http"),e=require("url"),f=e.parse(a,!0),g={host:f.hostname,port:80,method:"GET",path:f.path},h=function(a){c(a)},i=d.request(g,function(a){a.on("data",function(a){h(JSON.parse(a))})});i.end()}return a},k=function(){return"undefined"!=typeof module&&module.exports?j():i()},l=k();return h.config={APIURL:"http://appdev.io/kraken/v2/schedule/",region:""},a.prototype.execute=function(a,b,c){var d=[];this.initialRequestURL=a,l(a,{},this.createScopedCallback(b,c,d))},a.prototype.proceedResponse=function(a,b,c,d){c=c.concat(a.data),a.nextBatchLink&&(this.nextBatchLinkURL=a.nextBatchLink.href),void 0!==b&&b--,(b>0||void 0===b)&&this.nextBatchLinkURL?l(this.nextBatchLinkURL,{},this.createScopedCallback(d,b,c)):d.bind(this)(c)},a.prototype.createScopedCallback=function(a,b,c){var d=function(d){this.proceedResponse(d,b,c,a)};return d.bind(this)},b.prototype.toString=function(){return this._name},b.prototype._getStringForOperation=function(a,b){return this._name+a+b},c.prototype=Object.create(b.prototype),c.prototype.equalTo=function(a){return this._getStringForOperation("=",a)},c.prototype.greaterThan=function(a){return this._getStringForOperation(">",a)},c.prototype.greaterThanOrEqualTo=function(a){return this._getStringForOperation(">=",a)},c.prototype.lessThan=function(a){return this._getStringForOperation("<",a)},c.prototype.lessThanOrEqualTo=function(a){return this._getStringForOperation("<=",a)},d.prototype=Object.create(b.prototype),d.prototype.equalTo=function(a){return this._getStringForOperation("=",a)},d.prototype.isMatching=function(a){return this._getStringForOperation("~",a)},e.prototype.each=function(a){this.items.forEach(a)},e.prototype.where=function(a){var b=Object.keys(a);return this.items.filter(function(c){return b.every(function(b){return c.hasOwnProperty(b)&&c[b]===a[b]})})},e.prototype.add=function(a){"[object Array]"===Object.prototype.toString.call(a)?this.items=this.items.concat(a):this.items.push(a)},e.prototype.get=function(a){return this.items[a]},e.prototype.toArray=function(){return this.items.slice(0)},f.prototype=Object.create(e.prototype),f.prototype.limit=function(a){return this._addURLElement("maxBatchSize="+a),this},f.prototype.fields=function(){return this._addURLElement("show="+Array.prototype.slice.call(arguments).join(",")),this},f.prototype.sort=function(a,b){if(("undefined"==typeof b||null===b)&&(b="asc"),"asc"!==b&&"desc"!==b)throw new Error('Invalid sort option, expecting "asc" or "desc"');return this._addURLElement("sort="+a+"("+b+")"),this},f.prototype.filter=function(){for(var a=0;a<arguments.length;a++)this._addURLElement(arguments[a]);return this},f.prototype.findOne=function(a){return this._buildURLFromElements(),this._request.execute(this._requestURL,this._createScopedCallback(a),1),this},f.prototype.findNext=function(a){return this._request.execute(this._request.nextBatchLink||this._buildURLFromElements(),this._createScopedCallback(a),1),this},f.prototype.findAll=function(a){return this._buildURLFromElements(),this._request.execute(this._requestURL,this._createScopedCallback(a)),this},f.prototype._addURLElement=function(a){this._queryStringElements.push(a)},f.prototype._buildURLFromElements=function(){return this._requestURL=h.config.APIURL,""!==h.config.region&&(this._requestURL+="regions/"+h.config.region+"/"),this._requestURL+=this._baseURL,this._requestURL+=this._queryStringElements.join("&"),this._requestURL},f.prototype._processData=function(a){this.add(a)},f.prototype._createScopedCallback=function(a){var b=function(b){this._processData(b),a.bind(this)(b)};return b.bind(this)},h.Broadcast=function(){f.call(this)},h.Broadcast.ID=new d("id"),h.Broadcast.TITLE=new d("title"),h.Broadcast.CATEGORY=new d("category"),h.Broadcast.EPISODE=new c("episode"),h.Broadcast.SYNOPSIS=new d("synopsis"),h.Broadcast.START=new c("start"),h.Broadcast.END=new c("end"),h.Broadcast.YEAR=new d("year"),h.Broadcast.VIDEO_ID=new d("videoId"),h.Broadcast.SELF_LINK=new d("selfLink"),h.Broadcast.MORE_LINK=new d("moreLink"),h.Broadcast.OPENGRAPH_LINK=new d("opengraphLink"),h.Broadcast.prototype=Object.create(f.prototype),h.Broadcast.prototype._baseURL="broadcasts.json?",h.utils.addFactory(h.Broadcast),h.Channel=function(){f.call(this)},h.Channel.ID=new d("id"),h.Channel.NAME=new d("name"),h.Channel.LOGICAL_POSITION=new c("logicalPosition"),h.Channel.SELF_LINK=new d("selfLink"),h.Channel.BROADCASTS_LINK=new d("broadcastsLink"),h.Channel.OPENGRAPH_LINK=new d("opengraphLink"),h.utils.addFactory(h.Channel),h.Channel.prototype=Object.create(f.prototype),h.Channel.prototype._baseURL="channels.json?",h.Region=function(){f.call(this)},h.Region.ID=new d("id"),h.Region.NAME=new d("name"),h.Region.CHANNEL_LINEUP_LINK=new d("channelLineupLink"),h.Region.SELF_LINK=new d("selfLink"),h.Region.TOP_BROADCASTS_LINK=new d("topBroadcastsLink"),h.Region.TOP_VIDEOS_LINK=new d("topVideosLink"),h.utils.addFactory(h.Region),h.Region.prototype=Object.create(f.prototype),h.Region.prototype._baseURL="regions.json?",h});